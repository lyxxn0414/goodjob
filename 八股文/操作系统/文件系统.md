### 文件系统

#### 基本组成

为每个文件分配两个数据结构：**索引节点（\*index node\*）和目录项（\*directory entry\*）**

- 索引节点，也就是 *inode*，用来记录文件的元信息，比如 inode 编号、文件大小、访问权限、创建时间、修改时间、**数据在磁盘的位置**等等。索引节点是文件的**唯一**标识，它们之间一一对应，也同样都会被存储在硬盘中，所以**索引节点同样占用磁盘空间**。
- 目录项，也就是 *dentry*，用来记录文件的名字、**索引节点指针**以及与其他目录项的层级关联关系。多个目录项关联起来，就会形成目录结构，但它与索引节点不同的是，**目录项是由内核维护的一个数据结构，不存放于磁盘，而是缓存在内存**。

索引节点和文件是唯一标识的，而目录项只是记录一个名字。因此可以多个目录项指向同一个索引文件。

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%E7%9B%AE%E5%BD%95%E9%A1%B9%E5%92%8C%E7%B4%A2%E5%BC%95%E5%85%B3%E7%B3%BB%E5%9B%BE.png)

- *超级块*，用来存储文件系统的详细信息，比如块个数、块大小、空闲块等等。
- *索引节点区*，用来存储索引节点；
- *数据块区*，用来存储文件或目录数据；



- 超级块：当文件系统挂载时进入内存；
- 索引节点区：当文件被访问时进入内存；

#### 虚拟文件系统（VFS）

给用户提供一个文件系统的统一接口

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.png)

#### 文件使用

操作系统维护一张打开文件表，存储文件指针（上次的读写位置），打开计数器（多个进程可能打开同一文件，计数器归0时才能关闭文件，删除条目），访问权限，磁盘位置。

文件系统操作单位是**数据块**

#### 文件存储

##### 链表法

在内存存放一张文件分配表，记录文件的下一块。

![显式链接](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E5%88%86%E9%85%8D%E8%A1%A8.png)

##### 索引法

文件头放一个索引数据块指针，指向索引数据块。索引数据块记录文件所在的数据块。

不够放怎么办：多级索引。索引里放索引

![索引的方式](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%E9%9D%9E%E8%BF%9E%E7%BB%AD%E7%A9%BA%E9%97%B4%E5%AD%98%E6%94%BE%E6%96%B9%E5%BC%8F-%E7%B4%A2%E5%BC%95%E6%96%B9%E5%BC%8F.png)

Unix：

![早期 Unix 文件系统](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/Unix%20%E5%A4%9A%E7%BA%A7%E7%B4%A2%E5%BC%95.png)

#### 软链接和硬链接

硬链接：指向同一块inode

软链接：新的inode，但数据块指向链接inode的数据块。因此可以跨文件系统。

#### 文件创建过程

- **查找或分配inode**：如果权限检查通过，内核接下来会为新文件分配一个 inode。inode 是一个文件系统对象，包含了文件的元数据，如文件类型、大小、权限、所有者、指向文件内容的指针等。
- **更新目录项**：文件系统会在父目录中创建一个新的目录项（directory entry），将文件名与分配给文件的 inode 关联起来。这一步确保了文件系统中可以通过路径名找到该文件。
- **分配存储空间**（如果需要）：对于某些文件（如通过 `open()` 创建的空文件），实际的存储空间分配可能会延迟到实际写入数据时进行。但对于需要立即写入数据的操作，文件系统会分配必要的存储块。
- **更新文件系统元数据**：创建文件的过程可能需要更新文件系统的一些元数据，包括空闲inode的列表、空闲存储块的列表、目录的修改时间等。