## 操作系统结构

### Linux内核

#### 内核

连接应用和硬件设备的桥梁。

![内核](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8/Kernel_Layout.png)

##### 4个基本能力

- 管理**内存**。决定**内存的分配和回收**。
- **进程调度**。决定哪个进程/线程使用CPU。
- 管理**硬件设备**。提供**进程与硬件间的通信能力。**
- **系统调用**。用户程序需要调用更高权限的服务时，需要系统调用。**用户程序和操作系统之间的接口**

##### 内核工作流程

内存被分为内核空间和用户空间。

内核代码可以访问所有内存，可以控制 cpu、内存、硬盘等硬件。

而用户代码只能访问用户空间。需要进入内核空间时，必须执行系统调用。

系统调用流程（本质上是**通过中断实现CPU的执行权限转交**）：

1. 用户程序发起系统调用，产生中断
2. CPU中断当前用户程序，跳转到**中断处理程序**（进入内核态），执行对应内核程序。
3. 内核处理完后，**主动发起中断**，将CPU执行权限移交用户程序。
4. 用户程序继续执行。

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8/systemcall.png)

#### Linux设计

Linux核心设计理念：

- 多任务(MultiTask)： 多个任务可以同时执行。
  分为并行和并发。
  **并行**指对于单个CPU，一个任务使用一段时间CPU后，切换到另一个任务。
  **并发**指多核CPU，多个任务可以被不同的CPU执行。
- 对称多处理（SMP）：每个CPU的地位等同。
  每个 CPU **都可以访问完整的内存和硬件资源**。
  =》每个程序都可以被分配到任意CPU上执行。
- ELF：Linux可执行文件的链接存储格式。
- **宏内核**：系统**内核的所有模块都运行在内核态**。

##### 宏内核与微内核的区别

![分别为宏内核、微内核、混合内核的操作系统结构](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8/OS-structure2.png)

**微内核**：内核态只保留最基本的能力。如中断，进程调度，虚拟机内存等。

把一些应用（如驱动程序，文件系统）放到了用户态，且应用之间是相互隔离的。

**好处**：

1. 单个应用出现故障/安全攻击，不会使整个操作系统挂掉。
2. 驱动开发更**灵活**。
   （Linux宏内核实现了**动态加载内核模块**，大部分设备驱动是以**可加载模块**的形式存在的，与内核其他模块**解藕**，让驱动开发和驱动加载更为方便、灵活。）

**缺点**：

1. 驱动一般会频繁调用底层能力，需要**频繁切换**到内核态



混合内核：

内核里有一个最小版本的内核（相当于微内核），其它模块在此基础上搭建（但还在内核态）。

整体看是宏内核，但里面包裹了一个微内核。

**Windows是混合内核**，也支持SMP, MultiTask，但可执行文件是PE（.exe,.dll,.sys等）





## 面经常见问题

### 进程/线程

#### 进程和线程区别

1. 各自是什么
2. 是否有独立地址空间，切换开销。
3. 多线程/多进程的健壮性
4. 通信方式。